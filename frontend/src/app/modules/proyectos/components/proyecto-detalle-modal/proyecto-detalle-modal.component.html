<div class="modal-overlay" (click)="cerrarModal()">
  <div class="modal-detalle" (click)="$event.stopPropagation()">

    <!-- HEADER -->
    <div class="modal-header">
      <div class="header-info">
        <h2>{{ proyecto.nombreProyecto }}</h2>
        <div class="meta-info">
          <span class="codigo">{{ proyecto.codigoProyecto }}</span>
          <span class="separador">•</span>
          <span class="cliente">{{ proyecto.clienteNombre }}</span>
        </div>
      </div>
      <button class="btn-close" (click)="cerrarModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- PROGRESO GENERAL -->
    <div class="progreso-general">
      <div class="progreso-header">
        <span>Progreso General</span>
        <span class="valor">{{ proyecto.progresoGeneral }}%</span>
      </div>
      <div class="barra-progreso">
        <div class="barra-fill" [style.width.%]="proyecto.progresoGeneral"></div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab" [class.active]="tabActiva === 'info'" (click)="tabActiva = 'info'">
        <i class="fas fa-info-circle"></i>
        Información
      </button>
      <button class="tab" [class.active]="tabActiva === 'areas'" (click)="tabActiva = 'areas'">
        <i class="fas fa-tasks"></i>
        Áreas y Avances
      </button>
      <button class="tab" [class.active]="tabActiva === 'materiales'" (click)="tabActiva = 'materiales'">
        <i class="fas fa-box"></i>
        Materiales
      </button>
      <button class="tab" [class.active]="tabActiva === 'observaciones'" (click)="tabActiva = 'observaciones'">
        <i class="fas fa-comment"></i>
        Observaciones
      </button>
    </div>

    <!-- CONTENIDO -->
    <div class="modal-content">

      <!-- TAB: INFORMACIÓN -->
      <div class="tab-content" *ngIf="tabActiva === 'info'">
        <div class="info-grid">
          <div class="info-item">
            <label>Tipo de Prenda</label>
            <span>{{ proyecto.tipoPrenda || 'No especificado' }}</span>
          </div>
          <div class="info-item">
            <label>Prioridad</label>
            <span class="badge" [ngClass]="'badge-' + proyecto.prioridad">
              {{ proyecto.prioridad }}
            </span>
          </div>
          <div class="info-item">
            <label>Estado</label>
            <span>{{ proyecto.estado }}</span>
          </div>
          <div class="info-item">
            <label>Cantidad Total</label>
            <span>{{ proyecto.cantidadTotal }} unidades</span>
          </div>
          <div class="info-item">
            <label>Cantidad Producida</label>
            <span>{{ proyecto.cantidadProducida || 0 }} unidades</span>
          </div>
          <div class="info-item">
            <label>Fecha Inicio</label>
            <span>{{ formatearFecha(proyecto.fechaInicio) }}</span>
          </div>
          <div class="info-item">
            <label>Fecha Fin</label>
            <span>{{ formatearFecha(proyecto.fechaFin) }}</span>
          </div>
          <div class="info-item">
            <label>Días Transcurridos</label>
            <span>{{ proyecto.diasTranscurridos }} días</span>
          </div>
          <div class="info-item full-width" *ngIf="proyecto.descripcion">
            <label>Descripción</label>
            <p>{{ proyecto.descripcion }}</p>
          </div>
        </div>
      </div>

      <!-- TAB: ÁREAS Y AVANCES -->
      <div class="tab-content" *ngIf="tabActiva === 'areas'">
        <app-avance-areas *ngIf="proyecto.idProyecto" [idProyecto]="proyecto.idProyecto"></app-avance-areas>
        <div class="areas-layout">

          <!-- LISTA DE ÁREAS -->
          <div class="areas-lista">
            <div class="area-item" *ngFor="let area of AREAS" [class.seleccionada]="areaSeleccionada?.id === area.id"
              [class.completa]="estaCompleta(area)" [class.en-progreso]="enProgreso(area)"
              (click)="seleccionarArea(area)">

              <div class="area-icon" [style.background-color]="area.color">
                <i class="fas" [ngClass]="area.icono"></i>
              </div>

              <div class="area-info">
                <div class="area-nombre">{{ area.nombre }}</div>
                <div class="area-progreso">
                  <div class="mini-barra">
                    <div class="mini-fill" [style.width.%]="getAvanceArea(area)" [style.background-color]="area.color">
                    </div>
                  </div>
                  <span class="porcentaje">{{ getAvanceArea(area) }}%</span>
                </div>
              </div>

              <div class="area-estado">
                <i class="fas" [ngClass]="getIconoEstadoArea(area)" [style.color]="getColorEstadoArea(area)">
                </i>
              </div>
            </div>
          </div>

          <!-- PANEL DE ÁREA SELECCIONADA -->
          <div class="area-detalle" *ngIf="areaSeleccionada">
            <div class="area-header">
              <div class="area-title">
                <i class="fas" [ngClass]="areaSeleccionada.icono" [style.color]="areaSeleccionada.color"></i>
                <h3>{{ areaSeleccionada.nombre }}</h3>
              </div>
              <div class="area-status" [class.completa]="estaCompleta(areaSeleccionada)"
                [class.en-progreso]="enProgreso(areaSeleccionada)">
                <i class="fas" [ngClass]="getIconoEstadoArea(areaSeleccionada)"></i>
                <span *ngIf="estaCompleta(areaSeleccionada)">Completada</span>
                <span *ngIf="enProgreso(areaSeleccionada)">En Progreso</span>
                <span *ngIf="pendiente(areaSeleccionada)">Pendiente</span>
              </div>
            </div>

            <p class="area-descripcion">{{ areaSeleccionada.descripcion }}</p>

            <!-- FORMULARIO DEL ÁREA -->
            <div class="form-area">

              <div *ngIf="esAreaControlCalidad" class="calidad-form">
                <div class="calidad-header">
                  <h4><i class="fas fa-vial"></i> Inspección manual por prenda</h4>
                  <span class="calidad-resumen">
                    {{ criteriosEvaluados }}/{{ criteriosCalidad.length }} criterios evaluados
                  </span>
                </div>
                <div class="calidad-kpis">
                  <span class="kpi kpi-ok">Cumple: {{ criteriosCumplen }}</span>
                  <span class="kpi kpi-bad">No cumple: {{ criteriosNoCumplen }}</span>
                  <span class="kpi kpi-na">No aplica: {{ criteriosNoAplica }}</span>
                </div>
                <div class="calidad-kpis">
                  <span class="kpi kpi-total">Guardadas: {{ historialInspeccionesCalidad.length }}</span>
                  <span class="kpi kpi-total">Cantidad: {{ totalGuardadoCalidad }}/{{ totalObjetivoCalidad }} ({{ porcentajeCompletadoCalidad }}%)</span>
                </div>

                <div class="calidad-talles">
                  <div class="talle-item" *ngFor="let t of seguimientoTalles; trackBy: trackByTalle">
                    <div class="talle-head">
                      <strong>{{ t.talle }}</strong>
                      <span class="talle-badge">{{ t.guardado }}/{{ t.objetivo }}</span>
                    </div>
                    <div class="talle-restante">Restante: {{ t.restante }}</div>
                    <input
                      type="number"
                      min="0"
                      [max]="t.restante"
                      [ngModel]="inspeccionPorTalleActual[t.talle]"
                      (ngModelChange)="actualizarCantidadTalle(t.talle, $event)"
                      [disabled]="!puedeEditarFormularioCalidad || t.restante === 0">
                  </div>
                </div>

                <div class="calidad-lista">
                  <div class="criterio-item" *ngFor="let criterio of criteriosCalidad; trackBy: trackByCriterio">
                    <div class="criterio-top">
                      <div class="criterio-main">
                        <div class="criterio-titulo">
                          <strong>{{ criterio.nombre }}</strong>
                          <span class="badge-critico" *ngIf="criterio.esCritico">Crítico</span>
                        </div>
                        <small>{{ criterio.descripcion }}</small>
                      </div>

                      <div class="criterio-acciones">
                        <button
                          type="button"
                          class="btn-criterio btn-cumple"
                          [class.active]="criterio.resultado === 'cumple'"
                          (click)="setResultadoCriterio(criterio, 'cumple')"
                          [disabled]="!puedeEditarFormularioCalidad">
                          <i class="fas fa-check"></i>
                          <span>Aprueba</span>
                        </button>
                        <button
                          type="button"
                          class="btn-criterio btn-no-cumple"
                          [class.active]="criterio.resultado === 'no_cumple'"
                          (click)="setResultadoCriterio(criterio, 'no_cumple')"
                          [disabled]="!puedeEditarFormularioCalidad">
                          <i class="fas fa-times"></i>
                          <span>No aprueba</span>
                        </button>
                        <button
                          type="button"
                          class="btn-criterio btn-no-aplica"
                          [class.active]="criterio.resultado === 'no_aplica'"
                          (click)="setResultadoCriterio(criterio, 'no_aplica')"
                          [disabled]="!puedeEditarFormularioCalidad">
                          <i class="fas fa-minus"></i>
                          <span>No aplica</span>
                        </button>
                      </div>
                    </div>

                    <textarea
                      rows="2"
                      [(ngModel)]="criterio.observacion"
                      placeholder="Observación del criterio (opcional)"
                      [disabled]="!puedeEditarFormularioCalidad">
                    </textarea>
                  </div>
                </div>

                <div class="calidad-alerta" *ngIf="criteriosNoCumplen > 0">
                  <i class="fas fa-exclamation-triangle"></i>
                  {{ criteriosNoCumplen }} criterio(s) marcados como "No cumple".
                </div>
                <div class="calidad-alerta" *ngIf="tieneExcesoEnTallesActuales">
                  <i class="fas fa-exclamation-triangle"></i>
                  Hay cantidades por talle que superan el restante permitido.
                </div>

                <div class="calidad-actions">
                  <button
                    type="button"
                    class="btn-guardar-inspeccion"
                    (click)="guardarInspeccionCalidad()"
                    [disabled]="!puedeGuardarInspeccionCalidad || guardandoInspeccionCalidad">
                    <i class="fas" [ngClass]="guardandoInspeccionCalidad ? 'fa-spinner fa-spin' : 'fa-save'"></i>
                    {{ guardandoInspeccionCalidad ? 'Guardando...' : 'Guardar inspección' }}
                  </button>
                  <button
                    type="button"
                    class="btn-limpiar-inspeccion"
                    (click)="reiniciarFormularioCalidad()"
                    [disabled]="guardandoInspeccionCalidad || !tieneCambiosInspeccionPendientes">
                    <i class="fas fa-eraser"></i>
                    Limpiar
                  </button>
                </div>
              </div>

              <!-- Aquí irán los campos específicos de cada área en el futuro -->
              <div *ngIf="!esAreaControlCalidad" class="form-placeholder">
                <i class="fas fa-clipboard-list"></i>
                <p>Formulario específico del área</p>
                <small>Los campos personalizados se agregarán aquí</small>
              </div>

              <!-- OBSERVACIONES DEL ÁREA -->
              <div class="form-group">
                <label>
                  <i class="fas fa-comment"></i>
                  Observaciones (opcional)
                </label>
                <textarea [(ngModel)]="observacionArea" rows="4"
                  placeholder="Agrega detalles o notas sobre el trabajo realizado en esta área..."
                  [disabled]="estaCompleta(areaSeleccionada)">
                </textarea>
              </div>

              <!-- BOTÓN DE CONTINUAR / FINALIZAR -->
              <button *ngIf="!estaCompleta(areaSeleccionada)" class="btn-continuar" [class.btn-finalizar]="esUltimaArea"
                (click)="continuarSiguienteArea()"
                [disabled]="procesandoArea || !puedeContinuarAreaSeleccionada() || !puedeContinuarControlCalidad">
                <i class="fas"
                  [ngClass]="procesandoArea ? 'fa-spinner fa-spin' : (esUltimaArea ? 'fa-flag-checkered' : 'fa-arrow-right')"></i>
                <span *ngIf="!procesandoArea">
                  {{ esUltimaArea ? 'Finalizar Proyecto' : 'Continuar a ' + siguienteArea?.nombreCorto }}
                </span>
                <span *ngIf="procesandoArea">Procesando...</span>
              </button>

              <small *ngIf="esAreaControlCalidad && !puedeContinuarControlCalidad"
                style="display:block; margin-top: .35rem; color: #9e9e9e;">
                Debe existir al menos una inspección guardada y no quedar cambios pendientes sin guardar.
              </small>

              <small *ngIf="esAreaControlCalidad && !puedeEditarFormularioCalidad"
                style="display:block; margin-top: .35rem; color: #9e9e9e;">
                Para cargar calidad, el área anterior debe estar al 100% y el proyecto debe estar En Proceso.
              </small>

              <small *ngIf="!puedeGestionarAvance" style="display:block; margin-top: .35rem; color: #9e9e9e;">
                Solo se puede avanzar áreas cuando el proyecto está en estado En Proceso.
              </small>
              <small *ngIf="puedeGestionarAvance && areaAnteriorSeleccionada && !estaCompleta(areaAnteriorSeleccionada)"
                style="display:block; margin-top: .35rem; color: #9e9e9e;">
                Debes completar el área anterior para continuar.
              </small>

              <button class="btn-retroceder" (click)="retrocederArea()"
                [disabled]="procesandoArea || !puedeRetrocederArea()">
                <i class="fas fa-arrow-left"></i>
                Volver al área anterior
              </button>

              <div class="area-completada-msg" *ngIf="estaCompleta(areaSeleccionada)">
                <i class="fas fa-check-circle"></i>
                <span>Esta área ya ha sido completada</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: MATERIALES -->
      <div class="tab-content" *ngIf="tabActiva === 'materiales'">
        <div class="materiales-lista">
          <div class="material-item" *ngFor="let material of proyecto.materiales">
            <div class="material-info">
              <span class="material-nombre">{{ material.nombreInsumo }}</span>
              <span class="material-cantidad">
                {{ material.cantidadAsignada }} {{ material.unidadMedida }}
              </span>
            </div>
            <div class="material-detalle" *ngIf="material.cantidadUtilizada">
              <small>Utilizado: {{ material.cantidadUtilizada }}</small>
            </div>
          </div>
          <div class="empty-state" *ngIf="!proyecto.materiales || proyecto.materiales.length === 0">
            <i class="fas fa-box-open"></i>
            <p>No hay materiales asignados</p>
          </div>
        </div>
      </div>

      <!-- TAB: OBSERVACIONES -->
      <div class="tab-content" *ngIf="tabActiva === 'observaciones'">
        <div class="observaciones-form">
          <textarea [(ngModel)]="nuevaObservacion" rows="3"
            placeholder="Escribe una observación general sobre el proyecto...">
          </textarea>
          <button class="btn-agregar-obs" (click)="agregarObservacion()"
            [disabled]="!nuevaObservacion.trim() || guardandoObservacion">
            <i class="fas" [ngClass]="guardandoObservacion ? 'fa-spinner fa-spin' : 'fa-plus'"></i>
            {{ guardandoObservacion ? 'Guardando...' : 'Agregar Observación' }}
          </button>
        </div>

        <div class="observaciones-lista">
          <div class="observacion-item" *ngFor="let obs of proyecto.observaciones">
            <div class="obs-header">
              <span class="obs-usuario">
                <i class="fas fa-user-circle"></i>
                {{ obs.nombreUsuario }}
              </span>
              <span class="obs-fecha">{{ formatearFecha(obs.fecha) }}</span>
            </div>
            <p class="obs-texto">{{ obs.descripcion }}</p>
          </div>
          <div class="empty-state" *ngIf="!proyecto.observaciones || proyecto.observaciones.length === 0">
            <i class="fas fa-comment-slash"></i>
            <p>No hay observaciones</p>
          </div>
        </div>
      </div>

    </div>

    <!-- FOOTER CON BOTONES ARCHIVAR/LIBERAR -->
    <div class="modal-footer">
      <!-- Botón Archivar (solo para proyectos NO archivados) -->
      <button *ngIf="proyecto.estado !== 'Archivado'" class="btn-archivar" (click)="archivarProyecto()"
        [disabled]="procesandoArchivo">
        <i class="fas" [ngClass]="procesandoArchivo ? 'fa-spinner fa-spin' : 'fa-archive'"></i>
        {{ procesandoArchivo ? 'Archivando...' : 'Archivar Proyecto' }}
      </button>

      <!-- Botón Liberar (solo para proyectos archivados) -->
      <button *ngIf="proyecto.estado === 'Archivado'" class="btn-liberar" (click)="liberarProyecto()"
        [disabled]="procesandoLiberacion">
        <i class="fas" [ngClass]="procesandoLiberacion ? 'fa-spinner fa-spin' : 'fa-lock-open'"></i>
        {{ procesandoLiberacion ? 'Liberando...' : 'Liberar Proyecto' }}
      </button>
    </div>
  </div>
</div>
