<div class="ordenes-container">
  <div class="header">
    <div class="breadcrumb">
      <span class="breadcrumb-item">√ìrdenes de Compra</span>
      <span class="breadcrumb-separator">></span>
      <span class="breadcrumb-item active">Listado de ordenes</span>
    </div>

    <div class="toolbar">
      <div class="search-box">
        <input type="text" [(ngModel)]="terminoBusqueda" placeholder="Buscar por n√∫mero, proveedor o estado..."
          class="search-input" />
      </div>

      <button class="btn-nuevo" (click)="abrirFormularioNuevo()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
        Nueva Orden
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando √≥rdenes de compra...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading" class="error-container">
    <p>‚ùå Error al cargar las √≥rdenes de compra</p>
    <button class="btn-retry" (click)="cargarOrdenes()">Reintentar</button>
  </div>

  <!-- Tabla de √≥rdenes -->
  <div *ngIf="!loading && !error" class="tabla-container">
    <table class="tabla-ordenes">
      <thead>
        <tr>
          <th>NRO. ORDEN</th>
          <th>PROVEEDOR</th>
          <th>FECHA SOLICITUD</th>
          <th>FECHA ENTREGA</th>
          <th>ESTADO</th>
          <th>TOTAL</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let orden of ordenesFiltradas" (click)="abrirDetalle(orden)" class="fila-clickeable">
          <td>
            <strong>{{ orden.nroOrden }}</strong>
          </td>
          <td>{{ orden.nombreProveedor }}</td>
          <td>{{ formatearFecha(orden.fechaSolicitud) }}</td>
          <td>{{ formatearFecha(orden.fechaEntregaEstimada || '') }}</td>
          <td>
            <span class="badge" [ngClass]="getEstadoClass(orden.estado)">
              {{ orden.estado }}
            </span>
          </td>
          <td>
            <strong>${{ orden.totalOrden | number:'1.2-2' }}</strong>
          </td>
          <td>
            <div class="acciones" (click)="$event.stopPropagation()">
              <!-- Habilitar control: solo para Pendiente o Aprobada -->
              <button *ngIf="orden.estado === 'Pendiente' || orden.estado === 'Aprobada'" class="btn-icon btn-habilitar"
                (click)="habilitarControl(orden, $event)" title="Habilitar control de recepci√≥n">‚úÖ</button>
              <!-- Recalcular: solo para Recibida -->
              <button *ngIf="orden.estado === 'Recibida'" class="btn-icon btn-recalcular"
                (click)="recalcularRecepcion(orden, $event)" title="Recalcular (reabrir control)">üîÑ</button>
              <!-- Eliminar: solo si no est√° en proceso o recibida -->
              <button *ngIf="orden.estado !== 'PendienteControl' && orden.estado !== 'Recibida'"
                class="btn-icon btn-delete" (click)="eliminarOrden(orden, $event)" title="Eliminar orden">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div *ngIf="ordenesFiltradas.length === 0" class="empty-state">
      <div class="empty-icon">üì¶</div>
      <h3>No se encontraron √≥rdenes de compra</h3>
      <p *ngIf="terminoBusqueda">Intenta ajustar los filtros o el t√©rmino de b√∫squeda</p>
      <p *ngIf="!terminoBusqueda">Comienza creando tu primera orden de compra</p>
      <button class="btn-agregar" (click)="abrirFormularioNuevo()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Agregar primer orden
      </button>
    </div>

    <!-- Info Footer -->
    <div *ngIf="ordenesFiltradas.length > 0" class="footer-info">
      Mostrando {{ ordenesFiltradas.length }} de {{ ordenes.length }} √≥rdenes
      <span *ngIf="terminoBusqueda">(filtrado)</span>
    </div>
  </div>

  <!-- Modal Formulario -->
  <app-orden-compra-form *ngIf="mostrarFormulario" (cerrar)="cerrarFormulario()"
    (ordenCreada)="cargarOrdenes()"></app-orden-compra-form>

  <!-- Modal Detalle -->
  <div *ngIf="mostrarDetalle && ordenSeleccionada" class="modal-overlay" (click)="cerrarDetalle()">
    <div class="modal-detalle" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalle de Orden: {{ ordenSeleccionada.nroOrden }}</h2>
        <button class="btn-close" (click)="cerrarDetalle()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="info-grid">
          <div class="info-item">
            <label>Proveedor:</label>
            <span>{{ ordenSeleccionada.nombreProveedor }}</span>
          </div>
          <div class="info-item">
            <label>Estado:</label>
            <span class="badge" [ngClass]="getEstadoClass(ordenSeleccionada.estado)">
              {{ ordenSeleccionada.estado }}
            </span>
          </div>
          <div class="info-item">
            <label>Fecha Solicitud:</label>
            <span>{{ formatearFecha(ordenSeleccionada.fechaSolicitud) }}</span>
          </div>
          <div class="info-item">
            <label>Fecha Entrega Estimada:</label>
            <span>{{ formatearFecha(ordenSeleccionada.fechaEntregaEstimada || '') }}</span>
          </div>
          <!-- Info control recepci√≥n -->
          <div class="info-item" *ngIf="ordenSeleccionada.fechaHabilitacionControl">
            <label>Control habilitado:</label>
            <span>{{ formatearFecha(ordenSeleccionada.fechaHabilitacionControl!) }}</span>
          </div>
          <div class="info-item" *ngIf="ordenSeleccionada.fechaRecepcionControl">
            <label>Control realizado:</label>
            <span>{{ formatearFecha(ordenSeleccionada.fechaRecepcionControl!) }}</span>
          </div>
          <div class="info-item" *ngIf="ordenSeleccionada.observacionControl">
            <label>Observaci√≥n control:</label>
            <span>{{ ordenSeleccionada.observacionControl }}</span>
          </div>
        </div>

        <h3>Insumos</h3>
        <table class="tabla-detalles">
          <thead>
            <tr>
              <th>Insumo</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detalle of ordenSeleccionada.detalles">
              <td>{{ detalle.nombreInsumo }}</td>
              <td>{{ detalle.cantidad }}</td>
              <td>${{ detalle.precioUnitario | number:'1.2-2' }}</td>
              <td>${{ detalle.subtotal | number:'1.2-2' }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right"><strong>TOTAL:</strong></td>
              <td><strong>${{ ordenSeleccionada.totalOrden | number:'1.2-2' }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="cerrarDetalle()">Cerrar</button>
        <button *ngIf="ordenSeleccionada.estado === 'Pendiente' || ordenSeleccionada.estado === 'Aprobada'"
          class="btn-danger" (click)="rechazarOrden(ordenSeleccionada)">Rechazar</button>
        <!-- Habilitar control de recepci√≥n -->
        <button *ngIf="ordenSeleccionada.estado === 'Pendiente' || ordenSeleccionada.estado === 'Aprobada'"
          class="btn-primary" (click)="habilitarControl(ordenSeleccionada)">‚úÖ Habilitar Recepci√≥n</button>
        <!-- Recalcular (reabrir) -->
        <button *ngIf="ordenSeleccionada.estado === 'Recibida'" class="btn-warning"
          (click)="recalcularRecepcion(ordenSeleccionada)">üîÑ Recalcular</button>
      </div>
    </div>
  </div>

  <!-- Modal Recepci√≥n (legacy) -->
  <app-orden-compra-receive *ngIf="mostrarRecepcion && ordenSeleccionada" [orden]="ordenSeleccionada"
    (cerrar)="cerrarRecepcion()" (recepcionRegistrada)="cargarOrdenes()"></app-orden-compra-receive>
</div>